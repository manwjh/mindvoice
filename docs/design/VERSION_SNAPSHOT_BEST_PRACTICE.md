# 版本快照信息最佳实现方案

## 核心原则

1. **Git 仓库是唯一来源**：快照信息保存在 Git 仓库的 `version.ts` 中
2. **构建时直接使用**：构建时不进行网络请求，直接使用 Git 仓库中的快照信息
3. **维护者手动更新**：维护者在发布新版本前手动更新快照信息并提交到 Git

## 最佳实现方案

### 方案架构

```
┌─────────────────────────────────────────────────────────┐
│ Git 仓库（版本快照信息的唯一来源）                        │
│ - version.ts 包含快照信息                                │
│ - 快照信息随代码一起提交                                 │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 开发者拉取代码                                           │
│ - 快照信息已存在于代码中                                  │
│ - 无需任何额外操作                                       │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 构建应用                                                 │
│ - 直接使用 Git 仓库中的快照信息                          │
│ - 不进行网络请求                                         │
│ - 离线可构建                                             │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 打包应用                                                 │
│ - 包含版本快照信息                                       │
│ - 在"关于"页面显示贡献者信息                              │
└─────────────────────────────────────────────────────────┘
```

### 维护者工作流程（发布新版本时）

```
1. 准备发布新版本
   ↓
2. 运行 npm run sync:github
   - 从 GitHub API 获取最新贡献者信息
   - 更新 version.ts 中的快照信息
   ↓
3. 检查更新后的快照信息
   ↓
4. 提交更新到 Git 仓库
   git add electron-app/src/version.ts
   git commit -m "chore: update version snapshot for v1.9.3"
   ↓
5. 构建和打包
   npm run build
   npm run dist
```

## 实现细节

### 1. 移除构建时的自动同步

**修改 `package.json`**：
```json
{
  "scripts": {
    "sync:github": "node scripts/sync-github-snapshot.js",
    // 移除 prebuild 钩子，不再自动同步
    "build": "npm run build:vite && npm run build:electron"
  }
}
```

**原因**：
- 构建时不应该依赖网络
- Git 仓库中已有快照信息，直接使用即可
- 避免构建失败（网络问题）

### 2. 快照信息保存在 Git 仓库

**`version.ts` 中的快照信息**：
```typescript
// 这些信息会被提交到 Git 仓库
const VERSION_GITHUB_OWNER: GitHubOwner = { ... };
const VERSION_GITHUB_CONTRIBUTORS: GitHubContributor[] = [ ... ];
```

**提交策略**：
- 快照信息随代码一起提交
- 每次发布新版本时更新快照信息并提交

### 3. 手动更新机制

**维护者操作**：
```bash
# 发布新版本前，手动更新快照信息
npm run sync:github

# 检查更新
git diff electron-app/src/version.ts

# 提交更新
git add electron-app/src/version.ts
git commit -m "chore: update version snapshot for v1.9.3"
```

**优势**：
- 维护者可以控制何时更新
- 更新后可以检查确认
- 确保快照信息的准确性

### 4. 构建时直接使用

**构建流程**：
```
npm run build
  ↓
直接读取 version.ts 中的快照信息
  ↓
编译到应用中
  ↓
打包应用（包含快照信息）
```

**特点**：
- 无需网络请求
- 离线可构建
- 构建速度快
- 可靠性高

## 场景对比

### ❌ 错误方案：构建时自动同步

```
构建时 → 尝试从 GitHub API 获取 → 失败 → 使用现有信息
```

**问题**：
- 构建依赖网络
- 可能因网络问题导致构建失败
- 不符合"Git 仓库是唯一来源"的原则

### ✅ 正确方案：Git 仓库保存，构建时直接使用

```
Git 仓库（快照信息） → 拉取代码 → 构建时直接使用 → 打包应用
```

**优势**：
- 不依赖网络
- 构建可靠
- 版本一致
- 符合 Git 工作流

## 工作流程总结

### 维护者（发布新版本）

1. **更新快照信息**：`npm run sync:github`
2. **检查更新**：查看 `version.ts` 的变更
3. **提交到 Git**：`git commit`
4. **构建打包**：`npm run build && npm run dist`

### 开发者（拉取代码）

1. **拉取代码**：`git pull`
2. **快照信息已存在**：`version.ts` 中包含快照信息
3. **直接构建**：`npm run build`（无需网络）

### 用户（使用应用）

1. **安装应用**：包含版本快照信息
2. **查看"关于"页面**：看到贡献者信息
3. **了解开源要求**：看到 MIT 许可证说明

## 最佳实践建议

### 1. 版本发布检查清单

- [ ] 更新版本号（`version.ts`）
- [ ] 更新发布日期（`version.ts`）
- [ ] 运行 `npm run sync:github` 更新快照信息
- [ ] 检查快照信息是否正确
- [ ] 提交快照信息到 Git
- [ ] 构建和打包应用

### 2. Git 提交规范

```bash
# 更新快照信息的提交
git commit -m "chore: update version snapshot for v1.9.3"

# 或者包含在版本发布提交中
git commit -m "chore: release v1.9.3

- Update version to 1.9.3
- Update release date
- Update version snapshot"
```

### 3. 文档维护

- 在 `CONTRIBUTING.md` 中说明快照信息更新流程
- 在 `CHANGELOG.md` 中记录版本发布时的快照信息更新

## 总结

**最佳实现方案的核心**：
1. ✅ Git 仓库是快照信息的唯一来源
2. ✅ 构建时直接使用，不进行网络请求
3. ✅ 维护者手动更新，确保准确性
4. ✅ 离线可构建，可靠性高

**关键优势**：
- 🚀 构建速度快（无网络请求）
- 🔒 构建可靠（不依赖网络）
- 📦 版本一致（Git 仓库保证）
- 🎯 维护简单（手动控制更新时机）

